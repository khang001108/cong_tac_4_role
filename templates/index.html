<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 Relay Control</title>

    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      
      :root {
        --on: #22c55e;
        --off: #ef4444;
        --bg: #f2f4f7;
        --card: #ffffff;
      }
      
      body {
        margin: 0;
        font-family: system-ui, Arial;
        background: var(--bg);
      }
      
      .container {
        max-width: 420px;
        margin: auto;
        padding: 16px;
      }
      
      h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      
      .card {
        background: var(--card);
        border-radius: 16px;
        padding: 14px;
        margin-bottom: 14px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .label {
        font-size: 16px;
        font-weight: 600;
      }
      
      .status {
        font-size: 13px;
        opacity: 0.8;
      }
      
      .switch {
        position: relative;
        width: 52px;
        height: 30px;
      }
      
      .switch input {
        display: none;
      }
      
      .slider {
        position: absolute;
        inset: 0;
        background: #ccc;
        border-radius: 30px;
        transition: 0.25s;
        cursor: pointer;
      }
      
      .slider::before {
        content: '';
        position: absolute;
        width: 24px;
        height: 24px;
        left: 3px;
        top: 3px;
        background: #fff;
        border-radius: 50%;
        transition: 0.25s;
      }
      
      input:checked + .slider {
        background: var(--on);
      }
      
      input:checked + .slider::before {
        transform: translateX(22px);
      }
      
      .loading {
        opacity: 0.5;
        pointer-events: none;
      }
      
      /* ===== POPUP ===== */
      .popup {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      
      .popup-box {
        width: 90%;
        max-width: 320px;
        background: #fff;
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
        animation: popupIn 0.2s ease-out;
      }
      
      .popup-box h4 {
        margin: 0 0 12px;
      }
      
      .popup-box input {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 15px;
      }
      
      .popup-actions {
        display: flex;
        gap: 10px;
        margin-top: 14px;
      }
      
      .btn {
        flex: 1;
        padding: 10px;
        border-radius: 10px;
        border: none;
        font-size: 15px;
      }
      
      .btn.ok {
        background: #22c55e;
        color: #fff;
      }
      
      .btn.cancel {
        background: #e5e7eb;
      }
      
      @keyframes popupIn {
        from {
          transform: scale(0.95);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
    </style>
  </head>

  <body>
    <!-- PASSWORD POPUP -->
    <div id="lockPopup" class="popup" style="display:flex">
      <div class="popup-box">
        <h4>üîê Nh·∫≠p m·∫≠t kh·∫©u</h4>
        <input id="passwordInput" type="password" placeholder="M·∫≠t kh·∫©u..." inputmode="numeric" />
        <div class="popup-actions">
          <button class="btn ok" onclick="checkPassword()">M·ªü</button>
        </div>
        <p id="pwError" style="color:red;font-size:13px;display:none;margin-top:8px">‚ùå Sai m·∫≠t kh·∫©u</p>
      </div>
    </div>

    <!-- POPUP -->
    <div id="namePopup" class="popup">
      <div class="popup-box">
        <h4>‚úèÔ∏è ƒê·ªïi t√™n relay</h4>
        <input id="nameInput" placeholder="Nh·∫≠p t√™n relay..." />
        <div class="popup-actions">
          <button class="btn ok" onclick="saveName()">OK</button>
          <button class="btn cancel" onclick="closePopup()">Hu·ª∑</button>
        </div>
      </div>
    </div>

    <div class="container">
      <h2>üîå ESP32 Relay Control</h2>

      <div class="card" data-gpio="4">
        <div>
          <div class="label relay-name" data-gpio="4">Relay GPIO 4</div>
          <div class="status">OFF</div>
        </div>
        <label class="switch">
          <input type="checkbox" onchange="toggleRelay(this,4)" />
          <span class="slider"></span>
        </label>
      </div>

      <div class="card" data-gpio="5">
        <div>
          <div class="label relay-name" data-gpio="5">Relay GPIO 5</div>
          <div class="status">OFF</div>
        </div>
        <label class="switch">
          <input type="checkbox" onchange="toggleRelay(this,5)" />
          <span class="slider"></span>
        </label>
      </div>

      <div class="card" data-gpio="16">
        <div>
          <div class="label relay-name" data-gpio="16">Relay GPIO 16</div>
          <div class="status">OFF</div>
        </div>
        <label class="switch">
          <input type="checkbox" onchange="toggleRelay(this,16)" />
          <span class="slider"></span>
        </label>
      </div>

      <div class="card" data-gpio="17">
        <div>
          <div class="label relay-name" data-gpio="17">Relay GPIO 17</div>
          <div class="status">OFF</div>
        </div>
        <label class="switch">
          <input type="checkbox" onchange="toggleRelay(this,17)" />
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <script>
      const relayState = {}
      const API_BASE = 'https://cong-tac-4-role.onrender.com'
      const onTime = {}
      let editGPIO = null
      const PAGE_PASSWORD = '000'
      
      // ki·ªÉm tra m·∫≠t kh·∫©u
      function checkPassword() {
        const input = document.getElementById('passwordInput').value
        const err = document.getElementById('pwError')
      
        if (input === PAGE_PASSWORD) {
          document.getElementById('lockPopup').style.display = 'none'
          document.body.style.overflow = ''
        } else {
          err.style.display = 'block'
        }
      }
      
      // ch·∫∑n scroll khi ch∆∞a nh·∫≠p m·∫≠t kh·∫©u
      document.body.style.overflow = 'hidden'
      
      // cho ph√©p Enter ƒë·ªÉ m·ªü
      document.getElementById('passwordInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') checkPassword()
      })
      
      // ƒëi·ªÅu khi·ªÉn relay
      function toggleRelay(el, gpio) {
        const card = el.closest('.card')
        const statusEl = card.querySelector('.status')
        const value = el.checked ? 1 : 0
      
        card.classList.add('loading')
        statusEl.textContent = 'ƒêang g·ª≠i...'
      
        fetch(API_BASE + '/control', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gpio, value })
        })
          .then(() => {
            // kh√¥ng l√†m g√¨
            // ch·ªù server sync
          })
      
          .catch(() => {
            alert('‚ùå L·ªói k·∫øt n·ªëi server')
            el.checked = !el.checked
          })
          .finally(() => card.classList.remove('loading'))
      }
      
      // c·∫≠p nh·∫≠t th·ªùi gian ON m·ªói gi√¢y
      setInterval(() => {
        Object.keys(onTime).forEach((gpio) => {
          const card = document.querySelector(`.card[data-gpio="${gpio}"]`)
          if (!card) return
      
          const statusEl = card.querySelector('.status')
          const sec = Math.floor((Date.now() - onTime[gpio]) / 1000)
          statusEl.textContent = `ON ‚Ä¢ ${Math.floor(sec / 60)}m ${sec % 60}s`
        })
      }, 1000)
      
      // t·∫£i tr·∫°ng th√°i ban ƒë·∫ßu
      function loadStatus() {
        fetch(API_BASE + '/status')
          .then((res) => res.json())
          .then((data) => {
            Object.keys(data).forEach((gpio) => {
              const card = document.querySelector(`.card[data-gpio="${gpio}"]`)
              if (!card) return
      
              // ‚úÖ t√™n relay (c√≥ th·ªÉ update m·ªói l·∫ßn, kh√¥ng sao)
              card.querySelector('.relay-name').textContent = data[gpio].name
      
              const checkbox = card.querySelector('input')
              const statusEl = card.querySelector('.status')
      
              const newState = data[gpio].state
      
              // ‚úÖ CH·ªà UPDATE KHI STATE THAY ƒê·ªîI
              if (relayState[gpio] !== newState) {
                relayState[gpio] = newState
      
                checkbox.checked = newState === 1
      
                if (newState === 1) {
                  onTime[gpio] = Date.now()
                } else {
                  delete onTime[gpio]
                  statusEl.textContent = 'OFF'
                }
              }
            })
          })
      }
      
      loadStatus()
      setInterval(loadStatus, 2000) // m·ªói 2 gi√¢y
      
      // ƒë·ªïi t√™n relay khi nh·∫•n gi·ªØ
      document.querySelectorAll('.relay-name').forEach((el) => {
        const gpio = el.dataset.gpio
        let pressTimer
      
        el.addEventListener('touchstart', () => {
          pressTimer = setTimeout(() => openPopup(gpio), 600)
        })
        el.addEventListener('touchend', () => clearTimeout(pressTimer))
        el.addEventListener('touchmove', () => clearTimeout(pressTimer))
      
        el.addEventListener('mousedown', () => {
          pressTimer = setTimeout(() => openPopup(gpio), 600)
        })
        el.addEventListener('mouseup', () => clearTimeout(pressTimer))
        el.addEventListener('mouseleave', () => clearTimeout(pressTimer))
      })
      
      // m·ªü popup ƒë·ªïi t√™n
      function openPopup(gpio) {
        editGPIO = gpio
        document.getElementById('nameInput').value = document.querySelector(`.relay-name[data-gpio="${gpio}"]`).textContent
      
        document.getElementById('namePopup').style.display = 'flex'
        document.body.style.overflow = 'hidden'
      }
      
      // ƒë√≥ng popup
      function closePopup() {
        document.getElementById('namePopup').style.display = 'none'
        document.body.style.overflow = ''
      }
      
      // l∆∞u t√™n m·ªõi
      function saveName() {
        const name = document.getElementById('nameInput').value.trim()
        if (!name) return
      
        fetch(API_BASE + '/rename', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gpio: editGPIO, name })
        }).then(() => {
          document.querySelector(`.relay-name[data-gpio="${editGPIO}"]`).textContent = name
          closePopup()
        })
      }
    </script>
  </body>
</html>
